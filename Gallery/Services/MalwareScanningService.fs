namespace Gallery.Services

open System
open System.IO
open System.Threading.Tasks
open Microsoft.AspNetCore.Http
open Microsoft.Extensions.Configuration
open Microsoft.Extensions.Logging
open nClam

type ScanResult =
    | Clean
    | Infected of string
    | ScanError of string
    | ScanDisabled

type MalwareScanningService(configuration: IConfiguration, logger: ILogger<MalwareScanningService>) =

    let scanningEnabled =
        let configValue = configuration.["MalwareScanning:Enabled"]
        if String.IsNullOrEmpty(configValue) then false else Boolean.Parse(configValue)

    let clamAvServer =
        let configValue = configuration.["MalwareScanning:ClamAV:Server"]
        if String.IsNullOrEmpty(configValue) then "localhost" else configValue

    let clamAvPort =
        let configValue = configuration.["MalwareScanning:ClamAV:Port"]
        if String.IsNullOrEmpty(configValue) then 3310 else Int32.Parse(configValue)

    let maxFileSizeForScanMB =
        let configValue = configuration.["MalwareScanning:MaxFileSizeForScanMB"]
        if String.IsNullOrEmpty(configValue) then 25 else Int32.Parse(configValue)

    member private this.IsClamAvAvailable() =
        task {
            try
                let clam = new ClamClient(clamAvServer, clamAvPort)
                let! pingResult = clam.PingAsync()
                return pingResult
            with
            | ex ->
                logger.LogWarning("ClamAV ping failed: {Message}", ex.Message)
                return false
        }

    member private this.ScanWithClamAv(stream: Stream, fileName: string) =
        task {
            try
                let clam = new ClamClient(clamAvServer, clamAvPort)
                clam.MaxStreamSize <- int64 maxFileSizeForScanMB * 1024L * 1024L

                logger.LogInformation("Scanning file {FileName} with ClamAV", fileName)

                let! scanResult = clam.SendAndScanFileAsync(stream)

                match scanResult.Result with
                | ClamScanResults.Clean ->
                    logger.LogInformation("File {FileName} is clean", fileName)
                    return Clean
                | ClamScanResults.VirusDetected ->
                    logger.LogWarning("Virus detected in {FileName}: {VirusName}", fileName, scanResult.InfectedFiles.[0].VirusName)
                    return Infected (sprintf "Virus detected: %s" scanResult.InfectedFiles.[0].VirusName)
                | ClamScanResults.Error ->
                    logger.LogError("ClamAV scan error for {FileName}: {RawResult}", fileName, scanResult.RawResult)
                    return ScanError (sprintf "Scan error: %s" scanResult.RawResult)
                | _ ->
                    logger.LogError("Unknown scan result for {FileName}: {RawResult}", fileName, scanResult.RawResult)
                    return ScanError (sprintf "Unknown scan result: %s" scanResult.RawResult)
            with
            | ex ->
                logger.LogError(ex, "Exception during ClamAV scan of {FileName}", fileName)
                return ScanError (sprintf "Scan exception: %s" ex.Message)
        }

    member this.ScanFileAsync(file: IFormFile) =
        task {
            if not scanningEnabled then
                logger.LogDebug("Malware scanning is disabled")
                return ScanDisabled
            else
                let fileSizeMB = float file.Length / 1024.0 / 1024.0
                if fileSizeMB > float maxFileSizeForScanMB then
                    logger.LogWarning("File {FileName} ({Size:F2} MB) exceeds max scan size ({MaxSize} MB), skipping scan",
                        file.FileName, fileSizeMB, maxFileSizeForScanMB)
                    return ScanError (sprintf "File too large for scanning (%.2f MB > %d MB)" fileSizeMB maxFileSizeForScanMB)
                else
                    let! clamAvailable = this.IsClamAvAvailable()

                    if not clamAvailable then
                        logger.LogWarning("ClamAV is not available. Scanning disabled for {FileName}", file.FileName)
                        return ScanError "ClamAV service is not available"
                    else
                        use stream = file.OpenReadStream()
                        return! this.ScanWithClamAv(stream, file.FileName)
        }

    member this.ScanFilesAsync(files: IFormFile list) =
        task {
            if not scanningEnabled then
                return Ok ()
            else
                let mutable results = []

                for file in files do
                    let! scanResult = this.ScanFileAsync(file)
                    results <- (file.FileName, scanResult) :: results

                let infections =
                    results
                    |> List.choose (fun (fileName, result) ->
                        match result with
                        | Infected virus -> Some (sprintf "%s: %s" fileName virus)
                        | _ -> None
                    )

                if not infections.IsEmpty then
                    let message = sprintf "Malware detected in %d file(s): %s" infections.Length (String.Join("; ", infections))
                    logger.LogWarning("Malware scan failed: {Message}", message)
                    return Error message
                else
                    let errors =
                        results
                        |> List.choose (fun (fileName, result) ->
                            match result with
                            | ScanError err -> Some (sprintf "%s: %s" fileName err)
                            | _ -> None
                        )

                    if not errors.IsEmpty then
                        let message = sprintf "Scan errors for %d file(s): %s" errors.Length (String.Join("; ", errors))
                        logger.LogWarning("Malware scanning had errors: {Message}", message)
                        return Error message
                    else
                        logger.LogInformation("All files passed malware scan")
                        return Ok ()
        }

    member this.GetStatusAsync() =
        task {
            if not scanningEnabled then
                return "Malware scanning is disabled"
            else
                let! available = this.IsClamAvAvailable()
                if available then
                    return sprintf "ClamAV is available at %s:%d" clamAvServer clamAvPort
                else
                    return sprintf "ClamAV is NOT available at %s:%d" clamAvServer clamAvPort
        }
