@using Gallery.Models
@model PhotoViewModel

@{
    ViewData["Title"] = "Photo " + Model.PhotoNum;
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @Model.PlaceName</title>
    <link rel="stylesheet" href="~/css/fonts.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site.compiled.css" asp-append-version="true" />
    <style>
        body { font-family: 'DM Mono', monospace; }
        ::-webkit-scrollbar { display: none; }

        /* Keyboard focus styles */
        a:focus, button:focus {
            outline: 2px solid #000;
            outline-offset: 2px;
        }

        /* Skip to content link for screen readers */
        .skip-to-content {
            position: absolute;
            left: -9999px;
            z-index: 999;
        }
        .skip-to-content:focus {
            left: 50%;
            transform: translateX(-50%);
            top: 10px;
            background: black;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 4px;
        }

        /* Progressive image loading */
        .photo-container {
            position: relative;
        }
        .photo-placeholder {
            position: absolute;
            inset: 0;
            filter: blur(20px);
            transform: scale(1.1);
            transition: opacity 0.5s ease-out;
            z-index: 1;
        }
        .photo-main {
            position: relative;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        .photo-main.loaded {
            opacity: 1;
        }
        .photo-placeholder.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            transition: opacity 0.3s ease-out;
        }
        .loading-spinner.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #e5e5e5;
            border-top-color: #111;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @@keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Preload current image and adjacent images for smoother navigation -->
    <link rel="preload" href="/images/places/@(Model.PlaceId)/@(Model.FileName)" as="image" />
    @if (Model.NextPhotoFileName != null && Microsoft.FSharp.Core.FSharpOption<string>.get_IsSome(Model.NextPhotoFileName))
    {
        <link rel="prefetch" href="/images/places/@(Model.PlaceId)/@(Model.NextPhotoFileName.Value)" as="image" />
    }
    @if (Model.PrevPhotoFileName != null && Microsoft.FSharp.Core.FSharpOption<string>.get_IsSome(Model.PrevPhotoFileName))
    {
        <link rel="prefetch" href="/images/places/@(Model.PlaceId)/@(Model.PrevPhotoFileName.Value)" as="image" />
    }
</head>
<body class="bg-[#F0F0F0] text-[#111] h-[100dvh] w-screen flex flex-col overflow-hidden selection:bg-black selection:text-white" role="application" aria-label="Photo viewer">

    <!-- Screen reader announcements -->
    <div role="status" aria-live="polite" aria-atomic="true" class="sr-only" id="photo-announcement">
        Photo @Model.PhotoNum of @Model.TotalPhotos - @Model.PlaceName, @Model.Location
    </div>

    <header class="flex justify-between items-center px-5 md:px-12 h-20 shrink-0 z-20" role="banner">

        <a href="@Url.Action("Index", "Place", new { slug = Model.PlaceSlug })"
           id="close-button"
           class="group inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-300 text-gray-500 hover:border-gray-400 hover:text-black transition-all duration-300 focus:ring-2 focus:ring-black focus:ring-offset-2"
           aria-label="Close photo viewer and return to @Model.PlaceName gallery"
           title="Close (ESC)">
            <span class="text-[10px] font-mono tracking-[0.1em] uppercase pt-px" aria-hidden="true">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </span>
        </a>

        <nav class="flex gap-4 text-gray-500" aria-label="Photo navigation" role="navigation">
            @if (Model.PrevPhoto.HasValue)
            {
                <a href="@Url.Action("Detail", "Place", new { placeSlug = Model.PlaceSlug, photoSlug = Model.PrevPhotoSlug.Value })"
                   id="prev-button"
                   class="group inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-300 hover:border-gray-400 hover:text-black transition-all duration-300 focus:ring-2 focus:ring-black focus:ring-offset-2"
                   aria-label="Previous photo (@(Model.PrevPhoto.Value) of @Model.TotalPhotos)"
                   title="Previous (Left Arrow)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </a>
            }
            else
            {
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-200 text-gray-300 cursor-default"
                      aria-label="No previous photo available"
                      role="button"
                      aria-disabled="true">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </span>
            }

            @if (Model.NextPhoto.HasValue)
            {
                <a href="@Url.Action("Detail", "Place", new { placeSlug = Model.PlaceSlug, photoSlug = Model.NextPhotoSlug.Value })"
                   id="next-button"
                   class="group inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-300 hover:border-gray-400 hover:text-black transition-all duration-300 focus:ring-2 focus:ring-black focus:ring-offset-2"
                   aria-label="Next photo (@(Model.NextPhoto.Value) of @Model.TotalPhotos)"
                   title="Next (Right Arrow)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </a>
            }
            else
            {
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full border border-gray-200 text-gray-300 cursor-default"
                      aria-label="No next photo available"
                      role="button"
                      aria-disabled="true">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                </span>
            }
        </nav>
    </header>

    <main id="main-image" class="flex-grow flex items-center justify-center p-4 md:p-8 relative w-full h-full overflow-hidden" role="main" tabindex="-1">

        <figure class="photo-container">
            <!-- Loading spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
            </div>

            <!-- Blurred placeholder (medium thumbnail) -->
            @{
                var nameWithoutExt = System.IO.Path.GetFileNameWithoutExtension(Model.FileName);
                var mediumFileName = nameWithoutExt + "-medium.webp";
            }
            <img src="/images/places/@(Model.PlaceId)/@mediumFileName"
                 alt=""
                 aria-hidden="true"
                 class="photo-placeholder max-h-[75vh] w-auto max-w-[95vw] md:max-w-[85vw] object-contain shadow-2xl block"
                 id="photoPlaceholder"
                 onerror="this.style.display='none';" />

            <!-- Full resolution image -->
            <img data-src="/images/places/@(Model.PlaceId)/@(Model.FileName)"
                 alt="@Model.PlaceName - Photo @Model.PhotoNum of @Model.TotalPhotos taken in @Model.Location, @Model.Country during @Model.TripDates.DisplayText"
                 class="photo-main max-h-[75vh] w-auto max-w-[95vw] md:max-w-[85vw] object-contain shadow-2xl block"
                 id="photoMain" />
        </figure>

    </main>

    <footer class="flex justify-between items-end px-5 md:px-12 h-20 pb-8 shrink-0 z-20" role="contentinfo">
        <div class="flex flex-col gap-1">
            <span class="text-black text-[10px] uppercase tracking-widest font-mono font-medium" aria-label="Location name">@Model.PlaceName</span>
            <span class="text-gray-500 text-[10px] uppercase tracking-widest font-mono" aria-label="Location details">@Model.Location, @Model.Country</span>
        </div>
        <div class="flex flex-col gap-1 text-right">
            <div class="flex gap-2 justify-end text-black text-[10px] font-mono" aria-label="Photo counter">
                <span aria-label="Current photo">@Model.PhotoNum.ToString("D2")</span>
                <span class="text-gray-400" aria-hidden="true">â–¶</span>
                <span class="text-gray-400" aria-label="Total photos">@Model.TotalPhotos</span>
            </div>
            <span class="text-gray-400 text-[10px] uppercase tracking-widest font-mono" aria-label="Photo ID">@Model.UniqueId</span>
        </div>
    </footer>

    <!-- Keyboard Navigation Script -->
    <script>
        (function() {
            'use strict';

            // Get navigation elements
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const closeButton = document.getElementById('close-button');
            const announcement = document.getElementById('photo-announcement');

            // Keyboard navigation handler
            document.addEventListener('keydown', function(e) {
                // Don't handle if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key) {
                    case 'ArrowLeft':
                    case 'Left': // For older browsers
                        e.preventDefault();
                        if (prevButton) {
                            announceNavigation('previous');
                            prevButton.click();
                        } else {
                            announceNavigation('first');
                        }
                        break;

                    case 'ArrowRight':
                    case 'Right': // For older browsers
                        e.preventDefault();
                        if (nextButton) {
                            announceNavigation('next');
                            nextButton.click();
                        } else {
                            announceNavigation('last');
                        }
                        break;

                    case 'Escape':
                    case 'Esc': // For older browsers
                        e.preventDefault();
                        announceNavigation('closing');
                        closeButton.click();
                        break;

                    case 'Home':
                        e.preventDefault();
                        announceNavigation('closing');
                        closeButton.click();
                        break;
                }
            });

            // Announce navigation to screen readers
            function announceNavigation(direction) {
                const photoNum = @Model.PhotoNum;
                const totalPhotos = @Model.TotalPhotos;
                const placeName = @Json.Serialize(Model.PlaceName);

                let message = '';
                switch(direction) {
                    case 'previous':
                        message = 'Loading previous photo, ' + (photoNum - 1) + ' of ' + totalPhotos;
                        break;
                    case 'next':
                        message = 'Loading next photo, ' + (photoNum + 1) + ' of ' + totalPhotos;
                        break;
                    case 'first':
                        message = 'Already at first photo';
                        break;
                    case 'last':
                        message = 'Already at last photo';
                        break;
                    case 'closing':
                        message = 'Closing photo viewer, returning to ' + placeName + ' gallery';
                        break;
                }

                if (announcement && message) {
                    announcement.textContent = message;
                }
            }

            // Preload adjacent images for faster navigation
            function preloadAdjacentImages() {
                @if (Model.PrevPhoto.HasValue)
                {
                    <text>
                    var prevImg = new Image();
                    prevImg.src = '/images/places/@(Model.PlaceId)/@(Model.PrevPhotoFileName.Value)';
                    </text>
                }

                @if (Model.NextPhoto.HasValue)
                {
                    <text>
                    var nextImg = new Image();
                    nextImg.src = '/images/places/@(Model.PlaceId)/@(Model.NextPhotoFileName.Value)';
                    </text>
                }
            }

            // Progressive image loading - load full resolution after placeholder
            function loadFullImage() {
                const mainImg = document.getElementById('photoMain');
                const placeholder = document.getElementById('photoPlaceholder');
                const spinner = document.getElementById('loadingSpinner');
                const fullSrc = mainImg.dataset.src;

                if (!fullSrc) return;

                const loader = new Image();

                loader.onload = function() {
                    mainImg.src = fullSrc;
                    mainImg.classList.add('loaded');

                    // Hide placeholder and spinner after transition
                    setTimeout(function() {
                        if (placeholder) placeholder.classList.add('hidden');
                        if (spinner) spinner.classList.add('hidden');
                    }, 100);
                };

                loader.onerror = function() {
                    // If full image fails, keep showing placeholder
                    if (spinner) spinner.classList.add('hidden');
                    if (placeholder) {
                        placeholder.classList.remove('photo-placeholder');
                        placeholder.style.filter = 'none';
                        placeholder.style.transform = 'none';
                    }
                };

                loader.src = fullSrc;
            }

            // Preload on page load
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    preloadAdjacentImages();
                    loadFullImage();
                });
            } else {
                preloadAdjacentImages();
                loadFullImage();
            }

            // Add visual feedback for keyboard users
            let lastInteraction = 'mouse';

            document.addEventListener('mousedown', function() {
                lastInteraction = 'mouse';
                document.body.classList.remove('keyboard-user');
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    lastInteraction = 'keyboard';
                    document.body.classList.add('keyboard-user');
                }
            });

            // Add help text for keyboard shortcuts (visible on focus)
            const helpText = document.createElement('div');
            helpText.className = 'sr-only';
            helpText.setAttribute('role', 'status');
            helpText.setAttribute('aria-live', 'polite');
            helpText.textContent = 'Keyboard shortcuts: Left and Right arrows to navigate photos, Escape to close viewer';
            document.body.appendChild(helpText);

        })();
    </script>

    <!-- Screen reader only styles -->
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Enhanced focus styles for keyboard users */
        body.keyboard-user *:focus {
            outline: 2px solid #000 !important;
            outline-offset: 3px !important;
        }
    </style>

</body>
</html>
